<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<style>

    :nth-child(1){ --n:1  ; --r:4vmin}
    :nth-child(2){ --n:2  ; --r:4vmin}
    :nth-child(3){ --n:3  ; --r:4vmin}
    :nth-child(4){ --n:4  ; --r:4vmin}
    :nth-child(5){ --n:5  ; --r:4vmin}
    :nth-child(6){ --n:6  ; --r:4vmin}
    :nth-child(7){ --n:7  ; --r:4vmin}
    :nth-child(8){ --n:8  ; --r:4vmin}
    :nth-child(9){ --n:9  ; --r:4vmin}
    :nth-child(10){--n:10 ; --r:4vmin}
    :nth-child(11){--n:11 ; --r:4vmin}
    :nth-child(12){--n:12 ; --r:4vmin}
    :nth-child(13){--n:13 ; --r:4vmin}
    :nth-child(14){--n:14 ; --r:4vmin}
    :nth-child(15){--n:15 ; --r:4vmin}
    :nth-child(16){--n:16 ; --r:4vmin}
    :nth-child(17){--n:17 ; --r:4vmin}
    :nth-child(18){--n:18 ; --r:4vmin}
    :nth-child(19){--n:19 ; --r:4vmin}
    :nth-child(20){--n:20 ; --r:4vmin}
    :nth-child(21){--n:21 ; --r:4vmin}
    :nth-child(22){--n:22 ; --r:4vmin}
    :nth-child(23){--n:23 ; --r:4vmin}
    :nth-child(24){--n:24 ; --r:4vmin}
    :nth-child(25){--n:25 ; --r:4vmin}
    :nth-child(26){--n:26 ; --r:4vmin}
    :nth-child(27){--n:27 ; --r:4vmin}
    :nth-child(28){--n:28 ; --r:4vmin}
    :nth-child(29){--n:29 ; --r:4vmin}
    :nth-child(30){--n:30 ; --r:4vmin}

    body{
        margin: 0;
        background-color: black;
    }

    .bound{
        position: fixed;
        left: 0;
        top: 0;
        margin: auto;
        width: calc( 99vw);
        height: calc( 99vh);
        /* line-height: 100vh; */
        margin-top: 0.5vh;
        /* border: solid 1px black; */
        /* padding-right: 10vmin;
        padding-bottom: 10vmin; */
        /* border: 1px white solid; */
    }

    .box:nth-child(n){
        user-select: none;
        position: absolute;
        background-color: hsl(calc(   var(--n) * 360 / 30       ), 80%, 50%);
        /* background: radial-gradient(circle at center center, hsl(calc(   var(--n) * 360 / 30       ), 80%, 20%), hsl(calc(   320 - var(--n) * 360 / 30 ), 80%, 20%)); */
        background: linear-gradient(calc( 360deg / 30 * var(--n)     ), hsl(calc(   var(--n) * 360 / 30       ), 90%, 60%),
        hsl(calc(   ( var(--n) + 3) * 360 / 30       ), 90%, 55%),
        hsl(calc(   ( var(--n) + 5 ) * 360 / 30       ), 80%, 55%),
        hsl(calc(   ( var(--n) + 7 ) * 360 / 30       ), 80%, 55%));
        box-shadow: 0px 0px 3px hsl(calc(   var(--n) * 360 / 30       ), 80%, 50%);

                    
        width: var(--r);
        height: var(--r);
        transform:translate(calc( 99vw / 2 - var(--r) / 2   ),calc( 99vh / 2 - var(--r) / 2   ));
        /* border: 1px solid black; */
        border-radius: 50%;
        font-size: calc( var(--r) / 2);
        color: rgb(236, 235, 235);
        text-align: center;
        line-height: var(--r);
        font-family: 'Courier New', Courier, monospace;

    }

    .time{
        display: fixed;
        margin: auto;
        color: aliceblue;
        font-size: 10vmin;
        font-family: 'Courier New', Courier, monospace;
        font-weight: bold;
    }
    
</style>

<body>
    
    <div id="bound" class="bound">
        <div id="box1"  onclick="change(1)" class="box"></div>
        <div id="box2"  onclick="change(2)" class="box"></div>
        <div id="box3"  onclick="change(3)" class="box"></div>
        <div id="box4"  onclick="change(4)" class="box"></div>
        <div id="box5"  onclick="change(5)" class="box"></div>
        <div id="box6"  onclick="change(6)" class="box"></div>
        <div id="box7"  onclick="change(7)" class="box"></div>
        <div id="box8"  onclick="change(8)" class="box"></div>
        <div id="box9"  onclick="change(9)" class="box"></div>
        <div id="box10" onclick="change(10)" class="box"></div>
        <div id="box11" onclick="change(11)" class="box"></div>
        <div id="box12" onclick="change(12)" class="box"></div>
        <div id="box13" onclick="change(13)" class="box"></div>
        <div id="box14" onclick="change(14)" class="box"></div>
        <div id="box15" onclick="change(15)" class="box"></div>
        <div id="box16" onclick="change(16)" class="box"></div>
        <div id="box17" onclick="change(17)" class="box"></div>
        <div id="box18" onclick="change(18)" class="box"></div>
        <div id="box19" onclick="change(19)" class="box"></div>
        <div id="box20" onclick="change(20)" class="box"></div>
        <div id="box21" onclick="change(21)" class="box"></div>
        <div id="box22" onclick="change(22)" class="box"></div>
        <div id="box23" onclick="change(23)" class="box"></div>
        <div id="box24" onclick="change(24)" class="box"></div>
        <div id="box25" onclick="change(25)" class="box"></div>
        <div id="box26" onclick="change(26)" class="box"></div>
        <div id="box27" onclick="change(27)" class="box"></div>
        <div id="box28" onclick="change(28)" class="box"></div>
        <div id="box29" onclick="change(29)" class="box"></div>
    </div>


    <!-- <div id="time" class="time">123456</div> -->
</body>

<script>
    // :nth-child(1)



    const bound = document.getElementById("bound")
    const boundStyle = getComputedStyle(bound)
    
    const boundX = parseFloat(boundStyle.width)
    const boundY = parseFloat(boundStyle.height)
    
    const dt = 1
    var time = 0
    
    function getRandom(rnd) {
        var pNum = Math.floor(Math.random() * rnd)
        var nNum = -1 * Math.floor(Math.random() * rnd)



        if (Math.abs(pNum) >= Math.abs(nNum)) return pNum
        return nNum

    }

    function getPN(){

        var Temp = Math.random()
        if(Temp>0.5) return +1
        if(Temp<=0.5) return -1
    }

    function initialV(){
        var result = (0.4 + Math.random())*3*getPN()
        return result
    }

    var num = 29
    var ball = []   
    var state = []

    for(i = 1 ; i<=num ; i++){
        
        document.querySelector(".box:nth-child(" + i + ")").style.setProperty("--r", + 4 + Math.abs(getRandom(6)) + "vmin") // + Math.abs(getRandom(6))
    }


    for(i=1 ; i<=num; i++){
        ball[i]={}
        ball[i].element=document.getElementById("box" + i)
        // ball[i].element.innerText = i
        ball[i].style = getComputedStyle(document.getElementById("box" + i))
        ball[i].r = parseFloat(ball[i].style.width) / 2       
        ball[i].ox = boundX / 2
        ball[i].oy = boundY / 2
        ball[i].x = ball[i].ox + ball[i].r
        ball[i].y = ball[i].oy + ball[i].r
        ball[i].px = ball[i].ox + ball[i].r
        ball[i].py = ball[i].oy + ball[i].r
        ball[i].vx = initialV()//0.5 * i
        ball[i].vy = initialV()//0.7 * i    
        // console.log(ball[i].r)
    }   

    // ball[1].x = 320
    // ball[2].x = 300
    // ball[3].x = 6*ball[1].r + 0.1
    // ball[4].x = 8*ball[1].r + 0.1
    // ball[5].x = 10*ball[1].r + 0.1
    // ball[6].x = 12*ball[1].r + 0.1

    // ball[1].vx = 0
    // ball[2].vx = 0
    // ball[3].vx = -0.2
    // ball[4].vx = -0.1
    // ball[5].vx = -0.0
    // ball[6].vx = -0.9

    // ball[1].y = 200
    // ball[2].y = 700
    // ball[3].y = 500
    // ball[4].y = 500
    // ball[5].y = 500
    // ball[6].y = 500

    // ball[1].vy = 0
    // ball[2].vy = -1
    // ball[3].vy = 0
    // ball[4].vy = 0
    // ball[5].vy = 0
    // ball[6].vy = 0



    for(i=1 ; i<=num; i++){
        state[i]=[]
        for(j=i ; j<=num; j++){
            state[i][j] = false
        }
    }

    function getPN(){

        var Temp = Math.random()
        if(Temp>0.5) return +1
        if(Temp<=0.5) return -1

    }
    
    function change(temp){
        ball[temp].vx = initialV()
        ball[temp].vy = initialV()
    }

    function squ(n1){
        return n1 * n1
    }

    function root(n1){
        return Math.sqrt(n1,2)
    }

    function dot(x1,y1,x2,y2){
        return x1*x2+y1*y2
    }

    function proj(x1,y1,x2,y2){
        temp = dot(x1,y1,x2,y2) / ( squ(x2) + squ(y2) )
        return [temp * x2 , temp * y2]
    }

    function dist(x1,y1,x2,y2){
        return root(squ(x1-x2)+squ(y1-y2))
    }


    setTimeout(function(){

        var Timer = setInterval(function(){

            // document.getElementById("time").innerText = time
            // console.log(time)
            time = time + dt
            for(i=1; i<=num; i++){       
                
                 
                
                    for(j=i;j<=num;j++){
                        if(j===i){
                            continue
                        }

                        dBallx = ball[i].x - ball[j].x
                        dBally = ball[i].y - ball[j].y

                        dBall = Math.pow(dBallx,2) + Math.pow(dBally,2)

                        if(dBall>=Math.pow(ball[i].r + ball[j].r,2)){
                            state[i][j] = true  
                                    
                        }

                        if(state[i][j] === true && dBall <= Math.pow(ball[i].r + ball[j].r,2)){



                            // console.log(`collision: ${i}-${j} ; R${i}:${ball[i].r} R${j}:${ball[j].r} dball:${dBall}`) 
                            // console.log(`collision: ${i}-${j} ; ${time}`) 
                            var vx1 = ball[i].vx
                            var vy1 = ball[i].vy
                            var vx2 = ball[j].vx
                            var vy2 = ball[j].vy

                            var x1 = ball[i].x
                            var y1 = ball[i].y
                            var x2 = ball[j].x
                            var y2 = ball[j].y
                            
                            var vax = (vx1 + vx2)
                            var vay = (vy1 + vy2)
                            // console.log(ball[i].vx,ball[j].vx)

                            // if((vx1*vx1+vy1*vy1)>=(vx2*vx2+vy2*vy2)){
                            //     // dBallx = ball[i].x - ball[j].x
                            //     // dBally = ball[i].y - ball[j].y
                            //     a = (vax * dBallx + vay * dBally) / (dBallx * dBallx + dBally * dBally) * dBallx
                            //     b = (vax * dBallx + vay * dBally) / (dBallx * dBallx + dBally * dBally) * dBally

                            //     ball[j].vx = a
                            //     ball[j].vy = b
                            //     ball[i].vx = vax - a
                            //     ball[i].vy = vay - b

                            var cx1 = x2 - x1   //ball i to ball j vector
                            var cy1 = y2 - y1   //ball i to ball j vector
                            var cx2 = x1 - x2   
                            var cy2 = y1 - y2   

                            var vp1 = proj(vx1,vy1,cx1,cy1) //project v1 on line of centers
                            var vp2 = proj(vx2,vy2,cx2,cy2) //project v1 on line of centers



                            var vcx = (vp1[0] + vp2[0]) / 2
                            var vcy = (vp1[1] + vp2[1]) / 2

                            // console.log(2*vcx,vp1[0])
                            // console.log(2*vcx,vp2[0])
                            // console.log(2*vcy,vp1[1])
                            // console.log(2*vcy,vp2[1])

                            var vp11x = 2 * vcx - vp1[0] + vx1 - vp1[0] // ball i velocity after collision
                            var vp22x = 2 * vcx - vp2[0] + vx2 - vp2[0] 

                            var vp11y = 2 * vcy - vp1[1] + vy1 - vp1[1]  // ball i velocity after collision
                            var vp22y = 2 * vcy - vp2[1] + vy1 - vp1[1] 

                            // console.log(vp11x,vp11y,vp22x,vp22y)

                            ball[i].vx = vp11x
                            ball[j].vx = vp22x 

                            ball[i].vy = vp11y
                            ball[j].vy = vp22y 


                            //     // console.log("j")
                            //     // console.log(ball[i].vx,ball[j].vx)

                            // }

                            // else if((vx1*vx1+vy1*vy1)<(vx2*vx2+vy2*vy2)){
                            //     // dBallx = ball[i].x - ball[j].x
                            //     // dBally = ball[i].y - ball[j].y
                            //     a = (vax * dBallx + vay * dBally) / (dBallx * dBallx + dBally * dBally) * dBallx
                            //     b = (vax * dBallx + vay * dBally) / (dBallx * dBallx + dBally * dBally) * dBally

                            //     ball[i].vx = a
                            //     ball[i].vy = b
                            //     ball[j].vx = vax - a
                            //     ball[j].vy = vay - b


                            //     // console.log("i")
                            //     // console.log(ball[i].vx,ball[j].vx)
                            // }

                            // ball[i].px = ball[i].x + ball[i].vx * dt
                            // ball[i].py = ball[i].y + ball[i].vy * dt
                            // ball[j].px = ball[j].x + ball[j].vx * dt
                            // ball[j].py = ball[j].y + ball[j].vy * dt

                            // dBallpx = ball[i].px - ball[j].px
                            // dBallpy = ball[i].py - ball[j].py

                            // dBallp = Math.pow(dBallpx,2) + Math.pow(dBallpy,2)

                            // if(dBallp>Math.pow(ball[i].r + ball[j].r,2)){
                            //     continue                                      
                            // }

                            state[i][j] = false
                            
                        }
                    } 
                   
                // console.log(state)

                if(ball[i].x + ball[i].r > boundX | ball[i].x - ball[i].r<=0){
                    ball[i].vx = -ball[i].vx
                }
                if(ball[i].y + ball[i].r > boundY | ball[i].y - ball[i].r<=0){
                    ball[i].vy = -ball[i].vy
                }

                              

                ball[i].x = ball[i].x + ball[i].vx * dt
                ball[i].y = ball[i].y + ball[i].vy * dt

                

                

                ball[i].element.style.transform = "translate(" + (ball[i].x - ball[i].r) + "px, " + (ball[i].y - ball[i].r) + "px)"

            }

        },dt)
    
    },2000)

</script>    

</html>
